# Implementation Plan: Chaud Project Village View

## Overview

Transform the Mage Tower app into a village view that reflects the state of all chaud-managed projects in `~/Code`. Each project becomes a building that grows and evolves based on development activity (worktrees, merged PRs).

## Data Model

### New Types (`src/types/project.ts`)

```typescript
type BuildingType = 'cottage' | 'market' | 'workshop' | 'laboratory' | 'manor' | 'tower';
type BuildingStage = 'planning' | 'foundation' | 'scaffolding' | 'constructed' | 'decorated';

interface ChaudProject {
  id: string;
  path: string;                    // e.g., "/Users/lucky/Code/restart"
  name: string;                    // e.g., "restart"
  building: Building;
  worktrees: Worktree[];
  mergeCount: number;              // Total merged PRs (determines building level)
  lastScanned: number;
}

interface Building {
  type: BuildingType;              // Generated by OpenAI based on project
  aesthetic: string;               // LLM-generated description for visual theming
  stage: BuildingStage;
  level: number;                   // Floors/height based on merge count
  position: { x: number; z: number };
}

interface Worktree {
  id: string;
  branch: string;
  path: string;
  minionId: string;                // Assigned minion
  isActive: boolean;
  createdAt: number;
}
```

### Building Type Mapping (LLM-guided)

| Project Nature | Building Type | Visual Style |
|---------------|---------------|--------------|
| Internal tools, utilities | `cottage` | Cozy home with chimney |
| Marketing/sales pages | `market` | Merchant stall/shop |
| Dev tools (like chaud) | `workshop` | Artificer's workshop with anvil |
| AI/ML/research projects | `laboratory` | Alchemist's lab with bubbling potions |
| Large platforms/apps | `manor` | Multi-story manor house |
| This minion project | `tower` | Wizard's tower (the hub) |

### Building Stage Progression

1. **planning** - Surveyor stakes in ground (new project, no worktrees yet)
2. **foundation** - Stone foundation visible (has .chaud, no active worktrees)
3. **scaffolding** - Wooden scaffolding, partial walls (active worktrees present)
4. **constructed** - Complete walls and roof (worktrees closed, PR not yet merged)
5. **decorated** - Full building with details, banners, lights (PR merged)

Level increases with each merged PR, adding height/floors to the building.

---

## Implementation Steps

### Phase 1: Project Scanner Service

**File: `src/lib/projectScanner.ts`**

1. Create async function `scanChaudProjects()`:
   - Use Node.js `fs` to scan `~/Code` for directories containing `.chaud`
   - For each project:
     - Read `.worktrees/` subdirectories to find active worktrees
     - Run `git log --oneline --merges` to count merged PRs
     - Extract project name from path
     - Read `README.md` and `package.json` for LLM context

2. Create function `getProjectContext(path)`:
   - Read first 500 chars of README.md
   - Read `name`, `description`, `keywords` from package.json
   - Return structured context for LLM

3. Create function `detectWorktreeChanges(project, previousState)`:
   - Compare current worktrees to cached state
   - Return { added: [], removed: [], unchanged: [] }

### Phase 2: OpenAI Building Aesthetic Generator

**File: `src/lib/buildingGenerator.ts`**

1. Create function `generateBuildingAesthetic(projectContext)`:
   - Call OpenAI gpt-4o-mini with prompt:
     ```
     Based on this project, determine the building type and aesthetic.
     Project: {name}
     Description: {readme excerpt}
     Tech stack: {from package.json}

     Respond with JSON:
     {
       "type": "cottage|market|workshop|laboratory|manor|tower",
       "aesthetic": "2-3 sentence visual description for a fantasy building"
     }
     ```
   - Cache result in project store (only generate once per project)

### Phase 3: Project Store

**File: `src/store/projectStore.ts`**

1. Create Zustand store with persistence:
   ```typescript
   interface ProjectStore {
     projects: ChaudProject[];
     wizardTower: Building;           // The minion app itself (always present)
     lastScanTime: number;
     isScanning: boolean;

     // Actions
     scanProjects: () => Promise<void>;
     addProject: (project: ChaudProject) => void;
     updateProject: (id: string, updates: Partial<ChaudProject>) => void;
     removeProject: (id: string) => void;
     assignMinionToWorktree: (worktreeId: string, minionId: string) => void;
     upgradeBuilding: (projectId: string) => void;
   }
   ```

2. Implement polling mechanism:
   - `useEffect` hook that calls `scanProjects()` every 60 seconds
   - Debounce to prevent rapid re-scans

### Phase 4: Village Scene Component

**File: `src/components/VillageScene.tsx`**

1. Create village layout manager:
   - Position buildings in a grid/spiral pattern around the wizard tower
   - Wizard tower (minion project) always at center
   - New buildings placed at next available position

2. Implement dynamic camera:
   - Calculate bounding box of all buildings
   - Auto-adjust orthographic camera zoom to fit all buildings
   - Smooth transitions when buildings are added

3. Create ground plane that expands with village size

### Phase 5: Building Components

**File: `src/components/Building.tsx`**

1. Create base `Building` component:
   - Props: `type`, `stage`, `level`, `aesthetic`, `position`
   - Render appropriate 3D model based on type
   - Apply stage-specific modifications (scaffolding, decorations)

2. Create building type variants:
   - `CottageBuilding.tsx` - Simple house, chimney, 1-3 floors
   - `MarketBuilding.tsx` - Open-front shop with awning
   - `WorkshopBuilding.tsx` - Industrial with anvil, tools outside
   - `LaboratoryBuilding.tsx` - Crooked tower with bubbling vats
   - `ManorBuilding.tsx` - Large multi-wing structure
   - `WizardTower.tsx` - Refactor existing Tower.tsx

3. Implement level scaling:
   - Each merged PR adds ~0.5 floors (visually stacks)
   - Max reasonable height: 10-12 floors

### Phase 6: Scaffolding & Construction Animation

**File: `src/components/BuildingScaffolding.tsx`**

1. Create scaffolding overlay component:
   - Wooden beams around building
   - Partially visible walls/roof
   - Animated minions on scaffolding (optional)

2. Implement stage transitions:
   - Smooth morph between stages when state changes
   - Particle effects for "construction dust"

### Phase 7: Worktree Minion Integration

**Modify: `src/store/gameStore.ts`**

1. Connect minion assignment to worktrees:
   - When new worktree detected → create/assign minion
   - Minion moves to associated building
   - Minion shown "working" on scaffolding

2. Handle worktree closure:
   - Minion returns to wizard tower
   - Building stage advances if PR merged

### Phase 8: Village Interaction

**File: `src/components/VillageInteraction.tsx`**

1. Implement click handlers:
   - Click building → zoom in, show project details panel
   - Click empty ground → prompt to start new project

2. Create "New Project" flow:
   - Show modal asking for project name/description
   - Execute `chaud bootstrap` command via API route
   - New building appears in planning stage

### Phase 9: API Routes

**File: `src/app/api/scan/route.ts`**

1. Create server-side project scanner:
   - POST `/api/scan` - triggers full scan
   - GET `/api/projects` - returns cached project list
   - Handles filesystem access (can't do this client-side in browser)

**File: `src/app/api/bootstrap/route.ts`**

1. Create project bootstrap endpoint:
   - POST `/api/bootstrap` - runs `chaud bootstrap <name>`
   - Returns new project path

**File: `src/app/api/generate-aesthetic/route.ts`**

1. Create OpenAI integration endpoint:
   - POST with project context
   - Returns building type and aesthetic
   - Requires `OPENAI_API_KEY` env var

### Phase 10: UI Updates

**Modify: `src/components/ui/`**

1. Create `ProjectPanel.tsx`:
   - Shows project details when building clicked
   - Lists active worktrees
   - Shows merge history
   - Link to open in terminal/editor

2. Update `GameLayout.tsx`:
   - Add village view toggle
   - Show project count, active worktree count

---

## File Changes Summary

### New Files
- `src/types/project.ts`
- `src/lib/projectScanner.ts`
- `src/lib/buildingGenerator.ts`
- `src/store/projectStore.ts`
- `src/components/VillageScene.tsx`
- `src/components/Building.tsx`
- `src/components/buildings/CottageBuilding.tsx`
- `src/components/buildings/MarketBuilding.tsx`
- `src/components/buildings/WorkshopBuilding.tsx`
- `src/components/buildings/LaboratoryBuilding.tsx`
- `src/components/buildings/ManorBuilding.tsx`
- `src/components/BuildingScaffolding.tsx`
- `src/components/VillageInteraction.tsx`
- `src/components/ui/ProjectPanel.tsx`
- `src/app/api/scan/route.ts`
- `src/app/api/bootstrap/route.ts`
- `src/app/api/generate-aesthetic/route.ts`

### Modified Files
- `src/types/game.ts` - Add building-related types
- `src/store/gameStore.ts` - Connect minions to worktrees
- `src/components/Tower.tsx` - Refactor to WizardTower, support levels
- `src/components/Scene.tsx` - Support village view mode
- `src/components/GameLayout.tsx` - Add village controls
- `src/components/Ground.tsx` - Make expandable for village

### Environment Variables
- `OPENAI_API_KEY` - Required for building aesthetic generation

---

## Technical Considerations

1. **Server vs Client**: Filesystem scanning must happen server-side via API routes since browser can't access `~/Code`

2. **Caching**: Building aesthetics are generated once and cached in localStorage to avoid repeated OpenAI calls

3. **Performance**: With many projects, consider:
   - Lazy loading building models
   - LOD (level of detail) for distant buildings
   - Instanced rendering for repeated elements

4. **Git Operations**: Use `child_process.exec` for git commands in API routes, not client-side

5. **Polling Strategy**: 60-second interval with debounce, skip if previous scan still running

---

## Open Questions for User

1. Should clicking "new project" allow custom project location, or always use `~/Code`?
2. Any preference for how buildings are arranged (grid, organic cluster, along a road)?
3. Should there be sound effects for construction/completion events?
